# آپلودر خودکار

این یه برنامه ساده با پایتونه که یه پوشه رو تو کامپیوترت رصد می‌کنه و هر تغییری توش اتفاق بیفته (مثل اضافه کردن، عوض کردن یا پاک کردن فایل) رو خودکار می‌فرسته به Google Drive. برای کساییه که حوصله ندارن دستی فایل آپلود کنن، مثلاً برای بک‌آپ کد یا اسناد که هی تغییر می‌کنن. این پروژه بیشتر برای برنامه‌نویسایی خوبه که می‌خوان توسعه‌ش بدن یا نگهش دارن.

## چی کار می‌کنه؟

- پوشه‌ای که می‌خوای رو لحظه‌ای با `watchdog` چک می‌کنه.
- فایل جدید یا تغییر کرده رو سریع می‌فرسته به Google Drive.
- اگه فایلی رو پاک کنی، از Google Drive هم پاکش می‌کنه.
- برای اتصال به Google Drive از OAuth 2.0 استفاده می‌کنه.
- تنظیماتت رو تو فایل `config.json` ذخیره می‌کنه.
- قبل آپلود با `socket` چک می‌کنه اینترنت وصله یا نه.
- همه چی رو با `logging` لاگ می‌کنه که اگه مشکلی پیش اومد، بتونی پیداش کنی.
- نگاشت فایل‌ها به Google Drive رو تو `file_map.json` نگه می‌داره.
- آپلودها به‌صورت resumable هستن تا برای فایل‌های بزرگ به مشکل نخوری.
- تست‌های کامل با پوشش ۱۰۰٪ داره (یه ویدیوی پوشش تست تو `media/coverage.mp4` هست).

## پیش‌نیازها

- پایتون ۳.۸ یا جدیدتر
- یه حساب گوگل که API Google Drive روش فعال باشه:
  - باید بری به [کنسول گوگل کلاد](https://console.cloud.google.com/)، یه پروژه جدید بسازی، API Google Drive رو فعال کنی و یه اعتبارنامه OAuth 2.0 (نوع دسکتاپ) بگیری تا فایل `credentials.json` ساخته بشه. برای راهنمایی قدم‌به‌قدم، به [راهنمای فعال‌سازی API درایو](https://developers.google.com/drive/api/quickstart/python) و [ساخت اعتبارنامه OAuth](https://developers.google.com/workspace/guides/create-credentials#desktop-app) مراجعه کن.
  - **مهم:** پروژه رو تو حالت تست (Testing) بذار تا گوگل اپ رو بررسی (verify) نکنه و بتونی بدون تأیید رسمی ازش استفاده کنی. برای این کار، تو بخش **OAuth Consent Screen** کنسول گوگل، گزینه **Testing** رو انتخاب کن و ایمیل خودت رو به‌عنوان tester اضافه کن. اینجوری فقط کسایی که ایمیلشون رو اضافه کردی می‌تونن لاگین کنن. برای تنظیم حالت تست، به [راهنمای تنظیم OAuth Consent Screen](https://support.google.com/cloud/answer/10311615) نگاه کن.
- اینترنت برای لاگین و آپلود.

## نصب

۱. مخزن رو کلون کن:
   ```
   git clone https://github.com/yourusername/auto_uploader
   cd auto_uploader
   ```

۲. پکیج‌های لازم رو نصب کن:
   ```
   pip install -r requirements.txt
   ```

## راه‌اندازی

۱. فایل `credentials.json` رو بنداز تو ریشه پروژه یا وقتی برنامه می‌پرسه، مسیرش رو بده.
   - **نکته:** API گوگل باید تو حالت تست (Testing) باشه تا گوگل اپ رو بررسی نکنه. برو به [کنسول گوگل کلاد](https://console.cloud.google.com/)، تو بخش **OAuth Consent Screen**، حالت **Testing** رو انتخاب کن و ایمیل خودت رو به‌عنوان tester اضافه کن. برای جزئیات، به [راهنمای تنظیم OAuth Consent Screen](https://support.google.com/cloud/answer/10311615) و [راهنمای ساخت اعتبارنامه](https://developers.google.com/workspace/guides/create-credentials#desktop-app) مراجعه کن. این کار باعث می‌شه فقط ایمیل‌های tester بتونن لاگین کنن و نیازی به تأیید اپ توسط گوگل نباشه. برای فعال‌سازی API و گرفتن `credentials.json`، روی [این راهنمای رسمی گوگل](https://developers.google.com/drive/api/quickstart/python) کلیک کن.
   - برنامه از scope محدود `drive.file` استفاده می‌کنه که فقط فایل‌هایی که خودش ساخته رو مدیریت می‌کنه.
۲. برنامه رو اجرا کن:
   ```
   python3 run.py
   ```
   - اگه تنظیمات قبلاً نباشه، ازت می‌پرسه مسیر `credentials.json` و پوشه‌ای که می‌خوای رصد بشه کجاست.
   - می‌تونی همون اول مسیرها رو با این دستور مستقیم بدی:
     ```
     python3 run.py --credentials /path/to/credentials.json --watch_folder /path/to/folder
     ```
   - برای دیدن راهنمای دستورات، بزن:
     ```
     python3 run.py --help
     ```
   - تنظیمات تو `src/config.json` ذخیره می‌شن. تو اولین اجرا، مرورگر باز می‌شه برای لاگین و توکنت تو `token.json` ذخیره می‌شه.
   - اگه اشتباهی پیش اومد و فایل‌ها غلط آپلود شدن، فایل‌های ساخته‌شده مثل `config.json`, `token.json`, `file_map.json`, `folder_id.txt` رو پاک کن و برنامه رو از اول ران کن تا همه‌چی ریست بشه.

## استفاده

فقط بزن:
```
python3 run.py
```

- برنامه شروع می‌کنه به چک کردن پوشه و هر تغییری رو می‌فرسته به Google Drive.
- اگه بخوای تنظیمات رو عوض کنی، می‌تونی اینجوری مسیرها رو مستقیم بدی:
  ```
  python3 run.py --credentials /path/to/credentials.json --watch_folder /path/to/folder
  ```

### یه مثال
فرض کن یه فایل `note.txt` تو پوشه‌ای که رصد می‌کنی درست کنی یا تغییرش بدی، برنامه خودش آپلودش می‌کنه به Google Drive. اگه پاکش کنی، از اونجا هم پاک می‌شه.

## طراحی ماژولار

پروژه طوری ساخته شده که هر بخش کار خودشو بکنه و بهم ریخته نشه:
- **لایه تنظیمات (`config_loader.py`, `app_runner.py`):** تنظیمات رو از JSON یا خط فرمان می‌خونه و مسیرها رو چک می‌کنه که خطای رانتایم نده.
- **لایه ابزارها:**
  - `file_utils.py`: فقط نگاشت فایل‌ها رو تو JSON مدیریت می‌کنه (ذخیره، خوندن، حذف).
  - `drive_utils.py`: کارای مربوط به API گوگل (مثل لاگین، ساخت پوشه، آپلود و حذف فایل) رو انجام می‌ده. آپلودها resumable هستن برای فایلای بزرگ.
  - `network_utils.py`: اینترنت رو با `socket` چک می‌کنه.
- **هسته اصلی (`watcher.py`, `main.py`):** رصدکننده (`watcher.py`) از `watchdog` استفاده می‌کنه و رویدادهای فایل (مثل ساخت، تغییر، حذف) رو هندل می‌کنه. `main.py` سرویس رو راه می‌ندازه و رصد رو شروع می‌کنه.
- **نقطه ورود (`run.py`):** همه‌چی رو هماهنگ می‌کنه.

این طراحی باعث می‌شه:
- تست‌نویسی راحت باشه (مثلاً API یا فایل‌ها رو mock کنی).
- بتونی بعداً مثلاً Google Drive رو با Dropbox عوض کنی.
- کد خوندنش راحت باشه (هر فایل کمتر از ۲۰۰ خطه و کارش مشخصه).

## ابزارهای توسعه

- **زبان:** پایتون ۳.۸ یا جدیدتر.
- **ماژول‌های داخلی:** `os` (مدیریت مسیرها)، `json` (نگاشت و تنظیمات)، `logging` (لاگ خطاها)، `pickle` (ذخیره توکن)، `time` (تاخیر تو رصد)، `socket` (چک اینترنت)، `argparse` (آرگومان‌های خط فرمان)، `sys` (خروج در خطاها).
- **ماژول‌های خارجی:** `google_auth_oauthlib.flow` (برای OAuth)، `googleapiclient.discovery` و `http` (برای API درایو)، `watchdog` (برای رصد فایل).
- **ابزارها:**
  - IDE: VS Code یا PyCharm.
  - تست: `pytest` با پوشش ۱۰۰٪.
  - کنترل نسخه: Git.
  - بدون رابط گرافیکی؛ فقط خط فرمان با لاگ.

## تست کردن

تست‌ها تو پوشه `tests/` هستن و با `pytest` و `unittest.mock` نوشته شدن. پوشش ۱۰۰٪ دارن و مسیرهای عادی، خطاها (مثل قطعی اینترنت یا JSON خراب) و موارد خاص (مثل فایل‌های مخفی) رو تست می‌کنن.

برای اجرا:
```
pytest tests/
```

برای دیدن پوشش تست:
```
coverage run -m pytest
coverage report
```

برای گزارش HTML:
```
coverage html
```

- **نکته:** تست‌ها وابستگی‌های خارجی (مثل API) رو mock می‌کنن، پس نیازی به `credentials.json` برای تست نیست.
- می‌تونی تست‌ها رو تو CI/CD (مثل GitHub Actions) قبل از ساخت تنظیمات اجرا کنی.
- یه ویدیوی پوشش تست تو `media/coverage.mp4` هست.

## تجربیات و خطاها

ساخت پروژه حدود ۲ هفته طول کشید (پاره‌وقت). چند تا نکته و خطای مهم:
- **رصد با Watchdog:** خیلی قابل اعتماده، ولی فایل‌های مخفی (مثل `.DS_Store`) رو نادیده می‌گیره تا سر و صدا نکنه.
- **OAuth:** سرور محلی برای لاگین خوب کار می‌کنه، ولی اگه کاربر اجازه نده، باید خطاشو درست مدیریت کنی.
- **آپلود Resumable:** برای فایل‌های بزرگ لازمه، چون جلوی کرش تو اینترنت ضعیف رو می‌گیره.
- **خطاها:**
  - **JSONDecodeError:** اگه `file_map.json` خراب بشه، تو `file_utils` دوباره ساخته می‌شه.
  - **HttpError (403/404):** مشکل دسترسی یا فایل پیدا نشد؛ لاگ می‌شه و رد می‌شه.
  - **قطعی اینترنت:** با `socket` چک می‌شه و تو رویداد بعدی دوباره امتحان می‌کنه.
  - **انقضای توکن:** خودش رفرش می‌شه، ولی اگه scope اشتباه باشه (`drive.file` نباشه)، خطا می‌ده.
  - **مشکلات Watchdog:** تو ویندوز و لینوکس فرقایی داره؛ پروژه روی هر دو تست شده.
  - **تنظیمات گم‌شده:** برنامه ازت می‌پرسه و مسیرها رو چک می‌کنه که کرش نکنه.

**درس‌ها:** همیشه حسابی لاگ کن! طراحی ماژولار دیباگ رو خیلی راحت کرد.

## ساختار پروژه

```
.
├── media
│   └── coverage.mp4  # ویدیوی پوشش تست
├── requirements.txt  # پکیج‌های لازم
├── run.py            # فایل شروع برنامه
├── src
│   ├── app_runner.py     # راه‌اندازی و چک کردن مسیرها
│   ├── config_loader.py  # خوندن و ذخیره تنظیمات
│   ├── drive_utils.py    # کار با API گوگل درایو
│   ├── file_utils.py     # مدیریت نگاشت فایل‌ها
│   ├── __init__.py
│   ├── main.py           # هسته اصلی برنامه
│   ├── network_utils.py  # چک کردن اینترنت
│   └── watcher.py        # رصد تغییرات فایل
└── tests
    ├── __init__.py
    ├── test_app_runner.py    # تست راه‌اندازی
    ├── test_config_loader.py # تست تنظیمات
    ├── test_drive_utils.py   # تست ابزارهای درایو
    ├── test_file_utils.py    # تست نگاشت فایل
    ├── test_main.py          # تست هسته
    ├── test_network_utils.py # تست اینترنت
    └── test_watcher.py       # تست رصدکننده
```

## محدودیت‌ها

- API گوگل باید تو حالت تست باشه.
- اگه آپلود خراب بشه، خودش دوباره امتحان نمی‌کنه (باید دستی ری‌استارت کنی).
- فایل‌های مخفی (که با `.` شروع می‌شن) کلاً نادیده گرفته می‌شن.
- تغییر اسم یا جابجایی پوشه‌ها درست کار نمی‌کنه.
- فقط روی پایتون ۳.۸ یا جدیدتر تست شده، رو نسخه‌های قدیمی‌تر شاید به مشکل بخوری.
- برای راه‌اندازی باید دستی `credentials.json` رو درست کنی.

## کمک به پروژه

اگه دوست داری کمک کنی:
- مخزن رو فورک کن.
- تو یه شاخه جدا تغییراتت رو بده.
- تست برای چیزای جدید بنویس (بهتره TDD باشه).
- قبل از ارسال درخواست کش (pull request)، مطمئن شو همه تست‌ها پاس می‌شن و پوشش ۱۰۰٪ می‌مونه.

برای دیباگ، لاگ‌های برنامه یا `pdb` حسابی به کار میاد.

## لینک‌های مرتبط (تستی - بعداً پر کن)

- مقاله در dev.to: [ساخت آپلودر خودکار برای Google Drive: درس‌های آموخته‌شده]((https://dev.to/mohammadreza_mahdian_3841/learning-by-doing-the-autouploader-experience-a98)
- گیت‌هاب: [github.com/yourusername/auto_uploader](https://github.com/PyRz-Tech/auto_uploader)
- لینکدین: [linkedin.com/in/yourusername](https://www.linkedin.com/in/https://www.linkedin.com/in/mohammadreza-mahdian-38304038a)
- توییتر (X): [twitter.com/yourusername](https://twitter.com/PyRzTech)

## مجوز

این پروژه با مجوز MIT منتشر شده. اگه فایل [LICENSE](LICENSE) نبود، فرض کن برای استفاده شخصی رایگانه.
